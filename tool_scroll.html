
<!DOCTYPE html>
<html lang="en">
<head>
<title>Navigate your text</title>

<meta name="keywords" content="" />
<meta name="description" content = "" />
<meta name="viewport" content="width=device-width" />
<meta name="renderer" content="webkit" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />

<link href="css/bootstrap.min.css" rel="stylesheet" type="text/css" />

<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/bootstrap.js"></script>
<script type="text/javascript" src="js/jquery.mousewheel.js"></script>

<style>
  p.highlight {
    font-weight: bold;
    color: red;
  }
</style>

<script type="text/javascript">
  var cnt;
  var paras;

  var curParaIdx;
  var curSenIdx;

  var scrollIdx;
  var NCLICK = 24;

  var mode;

  function mod(n, m) {
    return ((n % m) + m) % m;
  }

  $(document).ready( function() { 
    curParaIdx = 0;
    curSenIdx = 0;

    scrollIdx = 0;

    mode = 1;

    cnt = $('#content-text').children('p').length;
    paras = $('#content-text').children('p');

    $(window).bind('keydown', function(e) {
      // window.alert(e.keyCode);
      if (e.keyCode == 83 /* s */) {
        cnt = $('#content-text').children('p').length;
        paras = $('#content-text').children('p');
        readText(0);
        startTracking();
      }
      if (e.keyCode == 69 /* e */) {
        $(window).off('mousewheel');
        window.speechSynthesis.cancel();
      }

      if (e.keyCode == 73 /* i */) {
        mode = 0;
        curSenIdx = scrollIdx;
        curParaIdx = scrollIdx;
      }
      if (e.keyCode == 79 /* o */) {
        mode = 1;
        curSenIdx = 0;
        curParaIdx = scrollIdx;
      }
    });

    $('#btn-content').click(function() {
      var text = $('#textarea-content').val();
      text = text.replace(/\n\r?/g, '<br />'); 
      $('#content-text').html(text);
      $('#content-text')
        .contents()
          .filter(function() {
            return this.nodeType === 3;
          })
            .wrap( "<p></p>" )
            .end()
          .filter( "br" )
          .remove();
      });

  });

  var startTracking = function() {
    // $(window).mousewheel(function(e) {
    //   scrollIdx = mod(scrollIdx + e.deltaY, NCLICK);
    //   readText(scrollIdx, mode);
    // });

    $(window).bind('keydown', function(e) {
      if (e.keyCode == 40 /* down */) {
        scrollIdx = mod(scrollIdx + 1, NCLICK);
        readText(scrollIdx, mode);
      }
      if (e.keyCode == 38 /* up */) {
        scrollIdx = mod(scrollIdx - 1, NCLICK);
        readText(scrollIdx, mode);
      }
    });
  };

  var readText = function(index, mode) {
    window.speechSynthesis.cancel();

    var end = -1;
    if (mode === 0 /* zoomed in */) {
      // read one sentence
      end = 1;
    } else if (mode === 1 /* zoomed out */) {
      // read the whole paragraph
      end = NCLICK;
    }

    for (var i = 0; i < end; i ++) {
      (function(ii){
        var idx_offseted = -1;
        if (mode === 0 /* zoomed in */) {
          idx_offseted = curParaIdx * NCLICK + index;
        } else if (mode === 1 /* zoomed out */) {
          idx_offseted = index * NCLICK + ii;
        }
        var curText = $(paras[idx_offseted]);

        var msg = new SpeechSynthesisUtterance();
        //var voices = window.speechSynthesis.getVoices();
        //msg.voice = voices[10]; // Note: some voices don't support altering params
        msg.voiceURI = 'native';
        msg.volume = 1; // 0 to 1
        msg.rate = 1.3; // 0.1 to 10
        msg.pitch = 1; //0 to 2
        msg.text = curText.text();
        msg.lang = 'en-US';
        
        msg.onstart = function(e) {
          curText.addClass('highlight');
        };
        
        msg.onend = function(e) {
          curText.removeClass('highlight');
        };

        window.speechSynthesis.speak(msg);
      }(i));
    }
  }

</script>

</head>
<body>

<div class="container-fluid">
  <div class="row">
    <div class="col-md-8">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Content</h3>
        </div>

        <div class="panel-body">
          <div id="content-text">
            <p>
              TEST PARAGRAPH
            </p>
            <p>
              Hey Jude, don't make it bad
            </p>
            <p>
              Take a sad song and make it better
            </p>
            <p>
              Remember to let her into your heart
            </p>
            <p>
              Then you can start to make it better
            </p>
            <p>
              Hey Jude, don't be afraid
            </p>
            <p>
              You were made to go out and get her
            </p>
            <p>
              The minute you let her under your skin
            </p>
            <p>
              Then you begin to make it better
            </p>
            <p>
              And anytime you feel the pain, hey Jude, refrain
            </p>
            <p>
              Don't carry the world upon your shoulders
            </p>
            <p>
              For well you know that it's a fool who plays it cool
            </p>
            <p>
              By making his world a little colder
            </p>
            <p>
              Nah nah nah nah nah nah nah nah nah
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">Instruction</h3>
          </div>

        <div class="panel-body">
          <div>
            <textarea id="textarea-content" type="text" class="form-control"></textarea>
            <button id="btn-content" class="btn btn-default" type="button" style="margin-top: 10px; margin-bottom: 10px;">Display</button>
          </div>
          <div id="coord">
            <span id="tag-idx" class="label label-info"></span>
          </div>
          After displaying the text, press <span class="label label-warning">s</span> to start and press <span class="label label-warning">e</span> to end. <br>
          Move mouse wheel or use the keys <span class="label label-warning">⬆</span>,<span class="label label-warning">⬇</span> to navigate. <br>
          Use <span class="label label-warning">i</span> to zoom in navigation level and <span class="label label-warning">o</span> to zoom out. <br>
        </div>
      </div>
    </div>

  </div>
</div>

</body>
</html>
